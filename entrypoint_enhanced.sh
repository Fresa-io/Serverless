#!/bin/bash

# Enhanced Entrypoint script for Lambda deployment with alias management
# DEV environment is local-only, no deployment needed

# Function to show usage
show_usage() {
    echo "üöÄ Enhanced Lambda Deployment Container"
    echo ""
    echo "Usage:"
    echo "  docker run --rm -it app deploy <encrypted_credentials>"
    echo ""
    echo "This will start the interactive deployment menu where you can:"
    echo "  ‚Ä¢ Test functions locally"
    echo "  ‚Ä¢ Run unit tests"
    echo "  ‚Ä¢ Deploy to STAGING/PROD"
    echo "  ‚Ä¢ Check deployment status"
    echo "  ‚Ä¢ And much more!"
    echo ""
    echo "Example:"
    echo "  docker run --rm -it app deploy YOUR_BASE64_ENCODED_CREDENTIALS"
    echo ""
    echo "Advanced Commands (for power users):"
    echo "  docker run --rm app hash <access_key> <secret_key> <region>"
    echo "  docker run --rm app setup-aliases <encrypted_credentials>"
    echo "  docker run --rm app promote <encrypted_credentials> <function> <source_env> <target_env>"
    echo "  docker run --rm app status <encrypted_credentials>"
    echo "  docker run --rm app test-local <function>"
    echo "  docker run --rm app test-unit <function>"
    echo "  docker run --rm app list-events [function]"
    echo "  docker run --rm -it app shell <encrypted_credentials>"
    echo ""
    echo "Environments: STAGING, PROD"
         echo "Functions: $(python3 utils/function_discovery.py list | tr '\n' ', ' | sed 's/,$//')"
    echo ""
    echo "üíª Note: DEV environment is local-only, no deployment needed"
    echo "üîê Security: Credentials are encrypted using base64 encoding for sharing"
}

# Function to setup AWS credentials
setup_aws_credentials() {
    local encrypted_creds="$1"
    
    echo "üîì Decrypting credentials..."
    DECRYPTED_OUTPUT=$(python3 utils/encrypt_utils.py decrypt "$encrypted_creds" 2>&1)
    
    if echo "$DECRYPTED_OUTPUT" | grep -q "Error:"; then
        echo "‚ùå $DECRYPTED_OUTPUT"
        echo ""
        echo "üí° Troubleshooting:"
        echo "1. Make sure you're using the exact hash generated by the 'hash' command"
        echo "2. Check that the hash hasn't been modified or truncated"
        echo "3. Try generating a new hash with: docker run --rm app hash <access_key> <secret_key> <region>"
        return 1
    fi
    
    # Extract credentials from Python output
    ACCESS_KEY=$(echo "$DECRYPTED_OUTPUT" | grep "Access Key:" | cut -d' ' -f3)
    SECRET_KEY=$(echo "$DECRYPTED_OUTPUT" | grep "Secret Key:" | cut -d' ' -f3)
    REGION=$(echo "$DECRYPTED_OUTPUT" | grep "Region:" | cut -d' ' -f2)
    
    if [ -z "$ACCESS_KEY" ] || [ -z "$SECRET_KEY" ] || [ -z "$REGION" ]; then
        echo "‚ùå Error: Failed to extract credentials from decryption output"
        echo "Debug output: $DECRYPTED_OUTPUT"
        return 1
    fi
    
    echo "‚úÖ Credentials decrypted successfully"
    echo "üåç Region: $REGION"
    
    # Configure AWS CLI
    echo "‚öôÔ∏è  Configuring AWS CLI..."
    aws configure set aws_access_key_id "$ACCESS_KEY"
    aws configure set aws_secret_access_key "$SECRET_KEY"
    aws configure set region "$REGION"
    aws configure set output json
    
    # Test AWS connection
    echo "üîç Testing AWS connection..."
    if aws sts get-caller-identity > /dev/null 2>&1; then
        echo "‚úÖ AWS connection successful"
        IDENTITY=$(aws sts get-caller-identity --query 'Arn' --output text)
        echo "üë§ Identity: $IDENTITY"
        return 0
    else
        echo "‚ùå AWS connection failed. Please check your credentials."
        return 1
    fi
}

# Function to show interactive menu
show_interactive_menu() {
    local encrypted_creds="$1"
    
    echo ""
    echo "üöÄ Lambda Deployment Interactive Menu"
    echo "====================================="
    echo ""
    echo "Available Actions:"
    echo "  1) üîç Show Deployment Status"
    echo "  2) üß™ Test Function Locally"
    echo "  3) üß™ Run Unit Tests"
    echo "  4) üìã List Test Events"
    echo "  5) üÜï Create New Lambda Function"
    echo "  6) üíª Interactive Shell"
    echo "  7) ‚ùå Exit"
    echo ""
    echo "üöÄ Deployment: All deployments happen via GitHub Actions CI/CD"
    echo "üìã Note: Use 'menu' command in shell to return to this menu"
    echo ""
}

# Function to show function selection menu
show_function_menu() {
    echo ""
    echo "üìã Available Functions:"
    
         # Dynamically discover functions
     mapfile -t functions < <(python3 utils/function_discovery.py list)
     
     # If no functions found, show message
     if [ ${#functions[@]} -eq 0 ]; then
         echo "  No Lambda functions found"
         echo "  Use option 10 to add a new function"
         return
     fi
    
    # Display functions
    for i in "${!functions[@]}"; do
        echo "  $((i+1))) ${functions[i]}"
    done
    
    echo "  $(( ${#functions[@]} + 1 ))) All Functions"
    echo "  $(( ${#functions[@]} + 2 ))) üîô Back to Main Menu"
    echo ""
}

# Function to get function selection
get_function_selection() {
    show_function_menu
    
         # Get functions array using dynamic discovery
     mapfile -t functions < <(python3 utils/function_discovery.py list)
     
     # If no functions found, return
     if [ ${#functions[@]} -eq 0 ]; then
         echo "back"
         return
     fi
    
    max_choice=$(( ${#functions[@]} + 2 ))
    echo "Select function (1-$max_choice): "
    read -r choice
    
    # Validate choice
    if [[ ! "$choice" =~ ^[0-9]+$ ]] || [ "$choice" -lt 1 ] || [ "$choice" -gt "$max_choice" ]; then
        echo "invalid"
        return
    fi
    
    # Handle selection
    if [ "$choice" -eq $(( ${#functions[@]} + 1 )) ]; then
        echo "all"
    elif [ "$choice" -eq $(( ${#functions[@]} + 2 )) ]; then
        echo "back"
    else
        # Return the selected function name (choice is 1-indexed)
        echo "${functions[$((choice-1))]}"
    fi
}

# Function to handle interactive menu
handle_interactive_menu() {
    local encrypted_creds="$1"
    
    # Setup AWS credentials first
    if ! setup_aws_credentials "$encrypted_creds"; then
        echo "‚ùå Failed to setup AWS credentials. Exiting."
        exit 1
    fi
    
    while true; do
        show_interactive_menu "$encrypted_creds"
        echo "Enter your choice (1-7): "
        read -r choice
        
        case $choice in
            1)  # Show Deployment Status
                echo "üìä Showing deployment status..."
                python3 scripts/deploy_with_aliases.py status
                ;;
            2)  # Test Function Locally
                while true; do
                    function=$(get_function_selection)
                    if [ "$function" = "back" ]; then
                        break
                    elif [ "$function" = "invalid" ]; then
                        echo "‚ùå Invalid selection"
                        continue
                    fi
                    
                    if [ "$function" = "all" ]; then
                        echo "üß™ Testing all functions locally..."
                                                 # Get all functions dynamically
                         while IFS= read -r func_name; do
                             echo "üß™ Testing $func_name..."
                             python3 scripts/local_test.py test "$func_name"
                             echo ""
                         done < <(python3 utils/function_discovery.py list)
                    else
                        echo "üß™ Testing $function locally..."
                        python3 scripts/local_test.py test "$function"
                    fi
                    break
                done
                ;;
            3)  # Run Unit Tests
                while true; do
                    function=$(get_function_selection)
                    if [ "$function" = "back" ]; then
                        break
                    elif [ "$function" = "invalid" ]; then
                        echo "‚ùå Invalid selection"
                        continue
                    fi
                    
                    if [ "$function" = "all" ]; then
                        echo "üß™ Running unit tests for all functions..."
                                                 # Get all functions dynamically
                         while IFS= read -r func_name; do
                             echo "üß™ Running unit tests for $func_name..."
                             python3 scripts/local_test.py test-unit "$func_name"
                             echo ""
                         done < <(python3 utils/function_discovery.py list)
                    else
                        echo "üß™ Running unit tests for $function..."
                        python3 scripts/local_test.py test-unit "$function"
                    fi
                    break
                done
                ;;
            4)  # List Test Events
                while true; do
                    function=$(get_function_selection)
                    if [ "$function" = "back" ]; then
                        break
                    elif [ "$function" = "invalid" ]; then
                        echo "‚ùå Invalid selection"
                        continue
                    fi
                    
                    if [ "$function" = "all" ]; then
                        echo "üìã Listing all test events..."
                        python3 scripts/local_test.py list-events
                    else
                        echo "üìã Listing test events for $function..."
                        python3 scripts/local_test.py list-events "$function"
                    fi
                    break
                done
                ;;
            5)  # Create New Lambda Function
                echo ""
                echo "üÜï Create New Lambda Function"
                echo "============================="
                echo ""
                echo "This will create a new Lambda function with:"
                echo "‚úÖ Function code template"
                echo "‚úÖ Unit tests template"
                echo "‚úÖ Test events template"
                echo "‚úÖ Updated configuration files"
                echo "‚úÖ Updated GitHub Actions workflow"
                echo "‚úÖ Updated interactive menu"
                echo "üìã Function naming rules:"
                echo "‚Ä¢ Use camelCase or snake_case: myFunction or my_function"
                echo "‚Ä¢ Examples: userLogin, processPayment, sendEmail"
                echo ""
                echo "Enter function name (or 'back' to cancel): "
                read -r function_name
                
                if [ "$function_name" = "back" ]; then
                    echo "‚ùå Cancelled function creation"
                elif [ -z "$function_name" ]; then
                    echo "‚ùå Function name cannot be empty"
                elif [[ ! "$function_name" =~ ^[a-zA-Z_][a-zA-Z0-9_]*$ ]]; then
                    echo "‚ùå Function name must be a valid identifier (letters, numbers, underscores)"
                else
                    echo ""
                    echo "üìÅ Select function category:"
                    echo "  1) Authentication (login, signup, auth)"
                    echo "  2) Processing (data processing, file handling)"
                    echo "  3) Communication (email, SMS, notifications)"
                    echo "  4) Analytics (reporting, data analysis)"
                    echo "  5) General (default category)"
                    echo "  6) Custom (enter your own category)"
                    echo ""
                    echo "Enter category choice (1-6): "
                    read -r category_choice
                    
                    case $category_choice in
                        1) category="Authentication" ;;
                        2) category="Processing" ;;
                        3) category="Communication" ;;
                        4) category="Analytics" ;;
                        5) category="General" ;;
                        6) 
                            echo "Enter custom category name: "
                            read -r category
                            if [ -z "$category" ]; then
                                category="General"
                            fi
                            ;;
                        *) 
                            echo "‚ùå Invalid choice. Using 'General' category."
                            category="General"
                            ;;
                    esac
                    
                    echo ""
                    echo "üöÄ Creating new Lambda function: $function_name"
                    echo "üìÅ Category: $category"
                    echo "================================================"
                    
                    # Check if function already exists in any category
                    if find Lambdas/ -type d -name "$function_name" | grep -q .; then
                        echo "‚ùå Function '$function_name' already exists!"
                        echo "Please choose a different name."
                    else
                        # Run the add_lambda_function.py script with category
                        if python3 scripts/add_lambda_function.py "$function_name" "$category"; then
                            echo ""
                            echo "üéâ Successfully created Lambda function: $function_name"
                            echo ""
                            echo "üìã Next steps:"
                            echo "1. Edit the function code: Lambdas/$category/$function_name/$function_name.py"
                            echo "2. Add your business logic"
                            echo "3. Test locally: Select option 3 from main menu"
                            echo "4. Deploy to staging: Select option 6 from main menu"
                            echo "5. Push to GitHub to trigger CI/CD"
                            echo ""
                            echo "üí° The function is now available in the interactive menu!"
                        else
                            echo "‚ùå Failed to create function. Please check the error messages above."
                        fi
                    fi
                fi
                ;;
            6) # Interactive Shell
                echo ""
                echo "üöÄ Starting interactive shell with AWS credentials configured..."
                echo "üí° Available commands:"
                echo "   python3 scripts/deploy_with_aliases.py status"
                echo "   python3 scripts/local_test.py test <function>"
                echo "   python3 scripts/local_test.py test-unit <function>"
                echo "   python3 scripts/local_test.py list-events [function]"
                echo "   python3 scripts/add_lambda_function.py <function> <category>"
                echo "   aws lambda list-functions"
                echo "   aws sts get-caller-identity"
                echo ""
                echo "üîÑ Type 'menu' to return to the interactive menu"
                echo "‚ùå Type 'exit' to leave the shell and return to menu"
                echo ""
                
                # Create a custom bash profile that includes the menu command
                export PS1="(lambda-deploy) $PS1"
                
                # Start interactive shell with custom environment
                bash --rcfile <(echo "
                    # Custom bash profile for Lambda deployment
                    alias menu='echo \"Returning to menu...\"; exit'
                    alias status='python3 scripts/deploy_with_aliases.py status'
                    alias ls-functions='python3 utils/function_discovery.py list'
                    alias test='python3 scripts/local_test.py test'
                    alias test-unit='python3 scripts/local_test.py test-unit'
                    alias list-events='python3 scripts/local_test.py list-events'
                    
                    echo 'üîÑ Type \"menu\" to return to the interactive menu'
                    echo 'üí° Type \"help\" to see available aliases'
                    
                    function help() {
                        echo 'Available aliases:'
                        echo '  menu        - Return to interactive menu'
                        echo '  status      - Show deployment status'
                        echo '  list        - List all aliases'
                        echo '  test        - Test function locally'
                        echo '  test-unit   - Run unit tests'
                        echo '  list-events - List test events'
                    }
                ")
                ;;
            7) # Exit
                echo "üëã Goodbye!"
                exit 0
                ;;
            *)  # Invalid choice
                echo "‚ùå Invalid choice. Please select 1-7."
                ;;
        esac
        
        echo ""
        echo "Press Enter to continue..."
        read -r
    done
}

# Main script logic
case "$1" in
    "deploy")
        if [ $# -ne 2 ]; then
            echo "‚ùå Error: deploy command requires 1 argument (encrypted_credentials)"
            echo ""
            echo "Usage:"
            echo "  docker run --rm -it app deploy <encrypted_credentials>"
            echo ""
            echo "Example:"
            echo "  docker run --rm -it app deploy YOUR_BASE64_ENCODED_CREDENTIALS"
            exit 1
        fi
        
        ENCRYPTED_CREDS="$2"
        
        # Start interactive menu automatically
        handle_interactive_menu "$ENCRYPTED_CREDS"
        ;;
        
    "hash")
        if [ $# -ne 4 ]; then
            echo "‚ùå Error: hash command requires 3 arguments (access_key, secret_key, region)"
            show_usage
            exit 1
        fi
        
        ACCESS_KEY="$2"
        SECRET_KEY="$3"
        REGION="$4"
        
        echo "üîê Creating encrypted credentials hash..."
        ENCRYPTED=$(python3 utils/encrypt_utils.py hash "$ACCESS_KEY" "$SECRET_KEY" "$REGION" | grep "Hash:" | cut -d' ' -f2)
        echo "‚úÖ Encrypted credentials hash:"
        echo "$ENCRYPTED"
        echo ""
        echo "üìã Use this hash for deployment:"
        echo "docker run --rm -it app deploy $ENCRYPTED"
        ;;
        
    "setup-aliases")
        if [ $# -ne 2 ]; then
            echo "‚ùå Error: setup-aliases command requires 1 argument (encrypted_credentials)"
            show_usage
            exit 1
        fi
        
        ENCRYPTED_CREDS="$2"
        
        if ! setup_aws_credentials "$ENCRYPTED_CREDS"; then
            exit 1
        fi
        
        echo "üè∑Ô∏è  Setting up aliases for all functions..."
        python3 scripts/lambda_alias_manager.py setup
        
        echo ""
        echo "üìä Alias Status:"
        python3 scripts/lambda_alias_manager.py list
        ;;
        
    "promote")
        if [ $# -ne 5 ]; then
            echo "‚ùå Error: promote command requires 4 arguments (encrypted_credentials, function, source_env, target_env)"
            show_usage
            exit 1
        fi
        
        ENCRYPTED_CREDS="$2"
        FUNCTION="$3"
        SOURCE_ENV="$4"
        TARGET_ENV="$5"
        
        if ! setup_aws_credentials "$ENCRYPTED_CREDS"; then
            exit 1
        fi
        
        echo "üîÑ Promoting $FUNCTION from $SOURCE_ENV to $TARGET_ENV..."
        python3 scripts/deploy_with_aliases.py promote "$FUNCTION" "$SOURCE_ENV" "$TARGET_ENV"
        
        echo ""
        echo "üìä Updated Status:"
        python3 scripts/deploy_with_aliases.py status
        ;;
        
    "status")
        if [ $# -ne 2 ]; then
            echo "‚ùå Error: status command requires 1 argument (encrypted_credentials)"
            show_usage
            exit 1
        fi
        
        ENCRYPTED_CREDS="$2"
        
        if ! setup_aws_credentials "$ENCRYPTED_CREDS"; then
            exit 1
        fi
        
        echo "üìä Deployment Status Report"
        echo "=" * 50
        python3 scripts/deploy_with_aliases.py status
        ;;
        
    "test-local")
        if [ $# -ne 2 ]; then
            echo "‚ùå Error: test-local command requires 1 argument (function)"
            show_usage
            exit 1
        fi
        
        FUNCTION="$2"
        
        echo "üß™ Testing function locally: $FUNCTION"
        python3 scripts/local_test.py test "$FUNCTION"
        ;;
        
    "test-unit")
        if [ $# -ne 2 ]; then
            echo "‚ùå Error: test-unit command requires 1 argument (function)"
            show_usage
            exit 1
        fi
        
        FUNCTION="$2"
        
        echo "üß™ Running unit tests for: $FUNCTION"
        python3 scripts/local_test.py test-unit "$FUNCTION"
        ;;
        
    "list-events")
        FUNCTION="${2:-}"
        
        if [ -n "$FUNCTION" ]; then
            echo "üìã Test events for $FUNCTION:"
            python3 scripts/local_test.py list-events "$FUNCTION"
        else
            echo "üìã All test events:"
            python3 scripts/local_test.py list-events
        fi
        ;;
        
    "shell")
        if [ $# -ne 2 ]; then
            echo "‚ùå Error: shell command requires 1 argument (encrypted_credentials)"
            show_usage
            exit 1
        fi
        
        ENCRYPTED_CREDS="$2"
        
        if ! setup_aws_credentials "$ENCRYPTED_CREDS"; then
            exit 1
        fi
        
        echo ""
        echo "üöÄ Starting interactive shell with AWS credentials configured..."
        echo "üí° Available commands:"
        echo "   python3 scripts/deploy_with_aliases.py status"
        echo "   python3 scripts/lambda_alias_manager.py list"
        echo "   python3 scripts/local_test.py test <function>"
        echo "   python3 scripts/local_test.py test-unit <function>"
        echo "   python3 scripts/local_test.py list-events [function]"
        echo "   aws lambda list-functions"
        echo "   aws sts get-caller-identity"
        echo ""
        echo "Type 'exit' to leave the shell"
        echo ""
        
        # Start interactive shell
        exec /bin/bash
        ;;
        
    *)  # Default: show usage
        show_usage
        exit 1
        ;;
esac 